<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Infinite Jazz Generator</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: 'Courier New', monospace; 
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #eee; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
            margin: 0;
            padding: 20px;
        }
        
        h1 { 
            color: #e94560; 
            text-shadow: 0 0 20px rgba(233, 69, 96, 0.5);
            margin-bottom: 5px;
            letter-spacing: 2px;
        }
        
        .progression { 
            color: #ffd369; 
            font-size: 14px; 
            margin-bottom: 20px;
            letter-spacing: 1px;
        }
        
        #controls { margin-bottom: 20px; text-align: center; }
        
        button { 
            padding: 12px 28px; 
            font-size: 16px; 
            cursor: pointer; 
            background: linear-gradient(135deg, #e94560, #ff6b6b); 
            border: none; 
            color: white; 
            border-radius: 25px;
            font-family: inherit;
            font-weight: bold;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.4);
        }
        button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(233, 69, 96, 0.6);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        button.playing {
            background: linear-gradient(135deg, #c0392b, #e74c3c);
        }
        
        button.secondary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        button.secondary:hover {
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .button-row {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .main-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 700px;
        }
        
        #display { 
            width: 280px; 
            min-height: 160px; 
            border: 2px solid #e94560; 
            background: rgba(0, 0, 0, 0.4); 
            padding: 25px; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            text-align: center;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .chord-display { 
            font-size: 42px; 
            font-weight: bold; 
            margin-bottom: 10px; 
            color: #ffd369;
            text-shadow: 0 0 15px rgba(255, 211, 105, 0.5);
        }
        .status { font-size: 13px; color: #888; }
        .note-log { font-size: 11px; color: #aaa; margin-top: 10px; height: 1.5em; }
        
        /* Configuration Panels */
        .config-panel {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid #4a5568;
            border-radius: 15px;
            padding: 20px;
            width: 280px;
            backdrop-filter: blur(10px);
        }
        
        .config-title {
            color: #e94560;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 2px;
            border-bottom: 1px solid #4a5568;
            padding-bottom: 8px;
        }
        
        .config-group {
            margin-bottom: 14px;
        }
        
        .config-group label {
            display: block;
            font-size: 10px;
            color: #a0aec0;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .config-group select,
        .config-group input[type="range"] {
            width: 100%;
            background: #2d3748;
            border: 1px solid #4a5568;
            color: #eee;
            padding: 8px 10px;
            border-radius: 6px;
            font-family: inherit;
            font-size: 12px;
        }
        
        .config-group select:focus {
            outline: none;
            border-color: #e94560;
        }
        
        .config-group input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            padding: 0;
            cursor: pointer;
        }
        
        .config-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #e94560;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .range-labels {
            display: flex;
            justify-content: space-between;
            font-size: 9px;
            color: #718096;
            margin-top: 3px;
        }
        
        .range-value {
            color: #ffd369;
            font-weight: bold;
        }
        
        .config-row {
            display: flex;
            gap: 10px;
        }
        
        .config-row .config-group {
            flex: 1;
        }
        
        /* Loading indicator */
        .loading {
            color: #ffd369;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>

<div id="controls">
    <h1>âˆ¿ Infinite Jazz Generator</h1>
    <p class="progression">Dm7 â†’ G7 â†’ Cmaj7 â†’ A7</p>
    <div class="button-row">
        <button id="startBtn">â–¶ Start Jazz</button>
        <button id="randomBtn" class="secondary">ðŸŽ² Random Style</button>
    </div>
</div>

<div class="main-container">
    <div id="display">
        <div class="chord-display" id="currentChord">â€”</div>
        <div class="status" id="phraseStatus">Waiting to swing...</div>
        <div class="note-log" id="noteLog"></div>
    </div>
    
    <!-- Musical Config Panel -->
    <div class="config-panel">
        <div class="config-title">ðŸŽµ Musical</div>
        
        <div class="config-row">
            <div class="config-group">
                <label>Tempo (BPM)</label>
                <input type="range" id="tempoSlider" min="70" max="160" value="110">
                <div class="range-labels">
                    <span>70</span>
                    <span class="range-value" id="tempoValue">110</span>
                    <span>160</span>
                </div>
            </div>
            <div class="config-group">
                <label>Swing</label>
                <input type="range" id="swingSlider" min="0" max="50" value="30">
                <div class="range-labels">
                    <span>0%</span>
                    <span class="range-value" id="swingValue">30%</span>
                    <span>50%</span>
                </div>
            </div>
        </div>
        
        <div class="config-group">
            <label>Comping Style</label>
            <select id="compStyle">
                <option value="whole">Whole Notes (Pad)</option>
                <option value="charleston" selected>Charleston (Jazz Standard)</option>
                <option value="bossa">Bossa Nova</option>
                <option value="driving">Driving Quarters</option>
                <option value="sparse">Sparse / Breathe</option>
                <option value="busy">Busy Bebop</option>
            </select>
        </div>
        
        <div class="config-group">
            <label>Melody Density</label>
            <select id="melodyDensity">
                <option value="sparse">Sparse (Space)</option>
                <option value="moderate" selected>Moderate</option>
                <option value="busy">Busy (Bebop)</option>
            </select>
        </div>
        
        <div class="config-row">
            <div class="config-group">
                <label>Lead Vol</label>
                <input type="range" id="leadVol" min="0" max="100" value="75">
                <div class="range-labels">
                    <span>0</span>
                    <span class="range-value" id="leadVolValue">75%</span>
                    <span>100</span>
                </div>
            </div>
            <div class="config-group">
                <label>Bass Vol</label>
                <input type="range" id="bassVol" min="0" max="100" value="70">
                <div class="range-labels">
                    <span>0</span>
                    <span class="range-value" id="bassVolValue">70%</span>
                    <span>100</span>
                </div>
            </div>
        </div>
    </div>
    
</div>

<script src="https://unpkg.com/soundfont-player@0.12.0/dist/soundfont-player.min.js"></script>
<script>
/**
 * CONFIGURATION & THEORY
 */

// Musical Constants
const SCALES = {
    "C_MAJOR": [0, 2, 4, 5, 7, 9, 11],
    "A_PHRYGIAN_DOM": [9, 10, 1, 2, 4, 5, 7]
};

const CHORD_PROGRESSION = [
    { name: "Dm7",   root: 2,  type: "m7",   scale: "C_MAJOR",        tones: [2, 5, 9, 0] },
    { name: "G7",    root: 7,  type: "7",    scale: "C_MAJOR",        tones: [7, 11, 2, 5] },
    { name: "Cmaj7", root: 0,  type: "maj7", scale: "C_MAJOR",        tones: [0, 4, 7, 11] },
    { name: "A7",    root: 9,  type: "7",    scale: "A_PHRYGIAN_DOM", tones: [9, 1, 4, 7] }
];

// Melody Rhythm Patterns
const MELODY_RHYTHMS = {
    sparse: [
        [0,0, 1,0, 0,0, 1,0],
        [1,0, 0,0, 0,1, 0,0],
        [0,0, 0,1, 0,0, 1,0],
    ],
    moderate: [
        [0,1, 1,0, 1,1, 1,0],
        [1,0, 1,0, 1,0, 1,0],
        [0,0, 1,0, 0,1, 1,0],
        [1,0, 0,1, 1,0, 0,1],
    ],
    busy: [
        [1,1, 1,1, 0,1, 1,0],
        [1,1, 0,1, 1,1, 1,0],
        [1,1, 1,0, 1,1, 1,1],
        [0,1, 1,1, 1,1, 0,1],
    ]
};

// Comping Patterns
const COMP_PATTERNS = {
    whole: [[{ beat: 0, dur: 1.8 }]],
    charleston: [
        [{ beat: 0, dur: 0.4 }, { beat: 3, dur: 0.3 }],
        [{ beat: 0, dur: 0.3 }, { beat: 3, dur: 0.5 }],
        [{ beat: 0, dur: 0.4 }, { beat: 3, dur: 0.25 }, { beat: 6, dur: 0.25 }],
    ],
    bossa: [
        [{ beat: 0, dur: 0.3 }, { beat: 3, dur: 0.3 }, { beat: 6, dur: 0.3 }],
        [{ beat: 0, dur: 0.25 }, { beat: 2, dur: 0.25 }, { beat: 5, dur: 0.3 }],
    ],
    driving: [
        [{ beat: 0, dur: 0.2 }, { beat: 2, dur: 0.2 }, { beat: 4, dur: 0.2 }, { beat: 6, dur: 0.2 }],
    ],
    sparse: [
        [{ beat: 0, dur: 0.8 }],
        [{ beat: 4, dur: 0.8 }],
    ],
    busy: [
        [{ beat: 0, dur: 0.2 }, { beat: 2, dur: 0.15 }, { beat: 3, dur: 0.2 }, { beat: 5, dur: 0.15 }, { beat: 7, dur: 0.2 }],
        [{ beat: 1, dur: 0.2 }, { beat: 3, dur: 0.2 }, { beat: 4, dur: 0.15 }, { beat: 6, dur: 0.2 }],
    ]
};

// Configuration state
const CONFIG = {
    tempo: 110,
    swing: 0.3,
    compStyle: 'charleston',
    melodyDensity: 'moderate',
    leadVol: 0.75,
    bassVol: 0.70
};

/**
 * AUDIO ENGINE (smplr + Web Audio)
 */
let audioContext;
let vibraphone, electricPiano, acousticBass;
let isPlaying = false;
let audioInitialized = false;
let schedulerInterval = null;

// Timing state
let startTime = 0;
let currentBar = 0;

async function initAudio() {
    if (audioInitialized) return;
    
    const statusEl = document.getElementById('phraseStatus');
    statusEl.textContent = "Loading samples...";
    statusEl.classList.add('loading');
    
    try {
        audioContext = new AudioContext();
        console.log("AudioContext created, state:", audioContext.state);
        
        // Resume if suspended (required by some browsers)
        if (audioContext.state === 'suspended') {
            await audioContext.resume();
            console.log("AudioContext resumed");
        }
        
        console.log("Loading instruments from soundfont...");
        
        // Load sample-based instruments using soundfont-player
        // Using MusyngKite soundfont for good quality
        const sf = 'MusyngKite';
        
        [vibraphone, electricPiano, acousticBass] = await Promise.all([
            Soundfont.instrument(audioContext, 'vibraphone', { soundfont: sf }),
            Soundfont.instrument(audioContext, 'electric_piano_1', { soundfont: sf }),
            Soundfont.instrument(audioContext, 'acoustic_bass', { soundfont: sf })
        ]);
        
        console.log("All instruments loaded!");
        statusEl.textContent = "Ready to swing!";
        statusEl.classList.remove('loading');
        
        audioInitialized = true;
    } catch (e) {
        console.error("Error initializing audio:", e);
        statusEl.textContent = "Error: " + e.message;
        statusEl.classList.remove('loading');
        throw e;
    }
}

/**
 * GENERATOR LOGIC
 */
function getMidi(pc, octave) { return pc + (octave + 1) * 12; }
function randomEl(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
function findNearest(target, pool) {
    return pool.reduce((prev, curr) => 
        Math.abs(curr - target) < Math.abs(prev - target) ? curr : prev
    );
}

// Melody state
let lastNoteMidi = 72;

function getEighthNoteDuration() {
    return 60 / CONFIG.tempo / 2; // seconds per eighth note
}

function generateBar(barIndex, barStartTime) {
    const chordIdx = barIndex % 4;
    const chordDef = CHORD_PROGRESSION[chordIdx];
    const eighthDur = getEighthNoteDuration();
    
    console.log(`Bar ${barIndex}: ${chordDef.name}, startTime=${barStartTime.toFixed(2)}, currentTime=${audioContext.currentTime.toFixed(2)}`);
    
    // Apply swing to off-beats
    function getSwungTime(beatIndex) {
        const baseTime = barStartTime + beatIndex * eighthDur;
        // Swing only affects odd eighth notes (the "ands")
        if (beatIndex % 2 === 1) {
            return baseTime + eighthDur * CONFIG.swing * 0.5;
        }
        return baseTime;
    }
    
    // ============ 1. COMPING CHORDS ============
    const voicing = [
        getMidi(chordDef.tones[0], 3),
        getMidi(chordDef.tones[1], 2),  // Drop-2
        getMidi(chordDef.tones[2], 3),
        getMidi(chordDef.tones[3], 3)
    ];
    
    const compPatterns = COMP_PATTERNS[CONFIG.compStyle];
    const compPattern = randomEl(compPatterns);
    
    compPattern.forEach(hit => {
        const hitTime = getSwungTime(hit.beat);
        const vel = hit.beat === 0 ? 0.52 : 0.45;  // Slightly accent downbeat
        
        voicing.forEach(midi => {
            electricPiano.play(midi, hitTime, {
                gain: vel * CONFIG.leadVol * 0.7,
                duration: hit.dur
            });
        });
    });
    
    // ============ 2. WALKING BASS ============
    const bassOctave = 2;
    const rootMidi = getMidi(chordDef.root, bassOctave);
    const bassDur = eighthDur * 1.8;
    
    // Beat 1: Root (strong)
    acousticBass.play(rootMidi, getSwungTime(0), {
        gain: 0.85 * CONFIG.bassVol,
        duration: bassDur
    });
    
    // Beat 2: 3rd or 5th
    const beat2Note = getMidi(randomEl([chordDef.tones[1], chordDef.tones[2]]), bassOctave);
    acousticBass.play(beat2Note, getSwungTime(2), {
        gain: 0.75 * CONFIG.bassVol,
        duration: bassDur
    });
    
    // Beat 3: 5th
    const fifthMidi = getMidi(chordDef.tones[2], bassOctave);
    acousticBass.play(fifthMidi, getSwungTime(4), {
        gain: 0.72 * CONFIG.bassVol,
        duration: bassDur
    });
    
    // Beat 4: Chromatic approach
    const nextChord = CHORD_PROGRESSION[(chordIdx + 1) % 4];
    const nextRoot = getMidi(nextChord.root, bassOctave);
    const approachNote = nextRoot + (Math.random() > 0.5 ? 1 : -1);
    acousticBass.play(approachNote, getSwungTime(6), {
        gain: 0.70 * CONFIG.bassVol,
        duration: bassDur * 0.9
    });
    
    // ============ 3. MELODY ============
    const melodyPatterns = MELODY_RHYTHMS[CONFIG.melodyDensity];
    const pattern = randomEl(melodyPatterns);
    
    const scalePool = SCALES[chordDef.scale].map(pc => getMidi(pc, 4))
        .concat(SCALES[chordDef.scale].map(pc => getMidi(pc, 5)));
    const chordPool = chordDef.tones.map(pc => getMidi(pc, 4))
        .concat(chordDef.tones.map(pc => getMidi(pc, 5)));
    const guideTones = [chordDef.tones[1], chordDef.tones[3]].map(pc => getMidi(pc, 4));
    
    pattern.forEach((step, index) => {
        if (step === 0) return;
        
        const noteTime = getSwungTime(index);
        const isStrongBeat = (index === 0 || index === 4);
        
        // Pitch selection
        let targetPool = scalePool;
        if (index === 0 && Math.random() < 0.7) {
            targetPool = guideTones;
        } else if (isStrongBeat) {
            targetPool = chordPool;
        } else if (Math.random() < 0.1) {
            targetPool = [lastNoteMidi + (Math.random() > 0.5 ? 1 : -1)];
        }
        
        let note = findNearest(lastNoteMidi, targetPool);
        
        // Occasional leaps
        if (Math.random() < 0.15) {
            const jump = Math.random() > 0.5 ? 5 : 7;
            const dir = Math.random() > 0.5 ? 1 : -1;
            note = findNearest(lastNoteMidi + (jump * dir), targetPool);
        }
        
        // Register lock
        if (note < 60) note += 12;
        if (note > 84) note -= 12;
        
        lastNoteMidi = note;
        
        const velocity = isStrongBeat ? 0.7 : 0.65;
        const duration = eighthDur * 1.2;
        
        vibraphone.play(note, noteTime, {
            gain: velocity * CONFIG.leadVol,
            duration: duration
        });
    });
    
    // Update UI
    setTimeout(() => {
        document.getElementById('currentChord').innerText = chordDef.name;
        document.getElementById('phraseStatus').innerText = "Improvising...";
    }, (barStartTime - audioContext.currentTime) * 1000);
}

/**
 * SCHEDULER
 */
const SCHEDULE_AHEAD = 0.5; // Schedule 500ms ahead
const LOOKAHEAD = 0.1;      // Check every 100ms

function scheduler() {
    const barDuration = getEighthNoteDuration() * 8;
    
    // Schedule bars whose start time is within our lookahead window
    while (startTime + currentBar * barDuration < audioContext.currentTime + SCHEDULE_AHEAD) {
        const barStartTime = startTime + currentBar * barDuration;
        // Only schedule if the bar hasn't already passed
        if (barStartTime > audioContext.currentTime - 0.05) {
            generateBar(currentBar, barStartTime);
        }
        currentBar++;
    }
}

function startLoop() {
    startTime = audioContext.currentTime + 0.1;
    currentBar = 0;
    
    console.log("Starting playback...");
    
    schedulerInterval = setInterval(scheduler, LOOKAHEAD * 1000);
    scheduler(); // Initial call
    
    isPlaying = true;
}

function stopLoop() {
    if (schedulerInterval) {
        clearInterval(schedulerInterval);
        schedulerInterval = null;
    }
    
    // Stop all sounds (soundfont-player uses stop())
    if (vibraphone) vibraphone.stop();
    if (electricPiano) electricPiano.stop();
    if (acousticBass) acousticBass.stop();
    
    isPlaying = false;
    document.getElementById('currentChord').innerText = "â€”";
    document.getElementById('phraseStatus').innerText = "Stopped";
}

/**
 * UI EVENT HANDLERS
 */
const startBtn = document.getElementById('startBtn');

startBtn.addEventListener('click', async () => {
    if (!isPlaying) {
        startBtn.disabled = true;
        await initAudio();
        startLoop();
        startBtn.innerHTML = "â–  Stop Jazz";
        startBtn.classList.add('playing');
        startBtn.disabled = false;
    } else {
        stopLoop();
        startBtn.innerHTML = "â–¶ Start Jazz";
        startBtn.classList.remove('playing');
    }
});

// Tempo
const tempoSlider = document.getElementById('tempoSlider');
const tempoValue = document.getElementById('tempoValue');
tempoSlider.addEventListener('input', (e) => {
    CONFIG.tempo = parseInt(e.target.value);
    tempoValue.textContent = CONFIG.tempo;
});

// Swing
const swingSlider = document.getElementById('swingSlider');
const swingValue = document.getElementById('swingValue');
swingSlider.addEventListener('input', (e) => {
    CONFIG.swing = parseInt(e.target.value) / 100;
    swingValue.textContent = e.target.value + '%';
});

// Comping Style
document.getElementById('compStyle').addEventListener('change', (e) => {
    CONFIG.compStyle = e.target.value;
});

// Melody Density
document.getElementById('melodyDensity').addEventListener('change', (e) => {
    CONFIG.melodyDensity = e.target.value;
});

// Lead Volume
const leadVolSlider = document.getElementById('leadVol');
const leadVolValue = document.getElementById('leadVolValue');
leadVolSlider.addEventListener('input', (e) => {
    CONFIG.leadVol = parseInt(e.target.value) / 100;
    leadVolValue.textContent = e.target.value + '%';
});

// Bass Volume
const bassVolSlider = document.getElementById('bassVol');
const bassVolValue = document.getElementById('bassVolValue');
bassVolSlider.addEventListener('input', (e) => {
    CONFIG.bassVol = parseInt(e.target.value) / 100;
    bassVolValue.textContent = e.target.value + '%';
});

/**
 * RANDOMIZE
 */
const compStyles = ['whole', 'charleston', 'bossa', 'driving', 'sparse', 'busy'];
const melodyDensities = ['sparse', 'moderate', 'busy'];

function randomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

function randomizeStyle() {
    // Musical params
    const newTempo = randomInt(80, 140);
    tempoSlider.value = newTempo;
    tempoValue.textContent = newTempo;
    CONFIG.tempo = newTempo;
    
    const newSwing = randomInt(15, 45);
    swingSlider.value = newSwing;
    swingValue.textContent = newSwing + '%';
    CONFIG.swing = newSwing / 100;
    
    const newCompStyle = compStyles[randomInt(0, compStyles.length - 1)];
    document.getElementById('compStyle').value = newCompStyle;
    CONFIG.compStyle = newCompStyle;
    
    const newMelodyDensity = melodyDensities[randomInt(0, melodyDensities.length - 1)];
    document.getElementById('melodyDensity').value = newMelodyDensity;
    CONFIG.melodyDensity = newMelodyDensity;
    
    const newLeadVol = randomInt(55, 90);
    leadVolSlider.value = newLeadVol;
    leadVolValue.textContent = newLeadVol + '%';
    CONFIG.leadVol = newLeadVol / 100;
    
    const newBassVol = randomInt(50, 85);
    bassVolSlider.value = newBassVol;
    bassVolValue.textContent = newBassVol + '%';
    CONFIG.bassVol = newBassVol / 100;
}

document.getElementById('randomBtn').addEventListener('click', randomizeStyle);

// Randomize on load
randomizeStyle();

</script>
</body>
</html>
