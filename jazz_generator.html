<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Infinite Jazz Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body { font-family: monospace; background: #222; color: #eee; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        #controls { margin-bottom: 20px; text-align: center; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background: #e67e22; border: none; color: white; border-radius: 4px; }
        button:hover { background: #d35400; }
        #display { width: 300px; height: 150px; border: 2px solid #444; background: #111; padding: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .chord-display { font-size: 32px; font-weight: bold; margin-bottom: 10px; color: #f1c40f; }
        .status { font-size: 14px; color: #888; }
        .note-log { font-size: 12px; color: #aaa; margin-top: 10px; height: 1.5em; }
    </style>
</head>
<body>

<div id="controls">
    <h1>Infinite Jazz Generator</h1>
    <p>Dm7 &rarr; G7 &rarr; Cmaj7 &rarr; A7</p>
    <button id="startBtn">Start Jazz</button>
</div>

<div id="display">
    <div class="chord-display" id="currentChord">--</div>
    <div class="status" id="phraseStatus">Waiting...</div>
    <div class="note-log" id="noteLog"></div>
</div>

<script>
/**
 * CONFIGURATION & THEORY
 */
const TEMPO = 110; // Slightly laid back
const LOOKAHEAD = 1.0; // Seconds to schedule ahead
const ROOT_MIDI = 60; // Middle C

// Musical Constants
const SCALES = {
    "C_MAJOR": [0, 2, 4, 5, 7, 9, 11], // C D E F G A B
    // A Phrygian Dominant (5th mode of D harmonic minor) for A7
    "A_PHRYGIAN_DOM": [9, 10, 1, 2, 4, 5, 7] // A Bb C# D E F G
};

const CHORD_PROGRESSION = [
    { name: "Dm7",   root: 2,  type: "m7",   scale: "C_MAJOR",        tones: [2, 5, 9, 0] },   // D F A C
    { name: "G7",    root: 7,  type: "7",    scale: "C_MAJOR",        tones: [7, 11, 2, 5] },  // G B D F
    { name: "Cmaj7", root: 0,  type: "maj7", scale: "C_MAJOR",        tones: [0, 4, 7, 11] },  // C E G B
    { name: "A7",    root: 9,  type: "7",    scale: "A_PHRYGIAN_DOM", tones: [9, 1, 4, 7] }    // A C# E G
];

// Rhythm Patterns (1 = play, 0 = rest, 2 = hold/sustain)
// 8 slots per bar (eighth notes)
const RHYTHMS = [
    [0,1, 1,0, 1,1, 1,0], // Syncopated start
    [1,0, 1,0, 1,0, 1,0], // Walking/Straight
    [0,0, 1,0, 0,1, 1,0], // Spacey
    [1,1, 1,1, 0,1, 0,0], // Busy start, rest end
    [1,0, 0,1, 0,0, 1,0]  // Sparse
];

/**
 * AUDIO ENGINE (Tone.js wrapper)
 */
let synth, bassSynth, chordSynth;
let isPlaying = false;

async function initAudio() {
    await Tone.start();
    
    // Create effects chain FIRST (don't connect to destination individually)
    const reverb = new Tone.Reverb({ decay: 2.5, wet: 0.35 });
    const delay = new Tone.FeedbackDelay({ 
        delayTime: "8n.", // Dotted eighth for jazz feel
        feedback: 0.15,   // Subtle
        wet: 0.12 
    });
    
    // Master chain: delay -> reverb -> destination
    delay.connect(reverb);
    reverb.toDestination();
    
    // Separate dry path with less volume
    const dryGain = new Tone.Gain(0.7).toDestination();
    
    // 1. Lead Synth (Vibraphone/Electric Piano feel)
    // Use FM synthesis for bell-like vibraphone tone
    synth = new Tone.PolySynth(Tone.FMSynth, {
        harmonicity: 3.01,
        modulationIndex: 1.5,
        oscillator: { type: "sine" },
        modulation: { type: "sine" },
        envelope: { attack: 0.001, decay: 0.4, sustain: 0.15, release: 1.2 },
        modulationEnvelope: { attack: 0.002, decay: 0.2, sustain: 0, release: 0.3 },
        volume: -8
    });
    synth.connect(dryGain);
    synth.connect(delay); // Goes through delay -> reverb chain

    // 2. Comping Chords (Warm Pad) - only reverb, no delay
    chordSynth = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: "triangle" },
        envelope: { attack: 0.3, decay: 1.2, sustain: 0.4, release: 2 },
        volume: -18
    });
    chordSynth.connect(reverb); // Direct to reverb only
    
    // 3. Upright Bass - Clean MonoSynth with lowpass filter (NO MembraneSynth!)
    const bassFilter = new Tone.Filter({
        type: "lowpass",
        frequency: 800,
        rolloff: -24
    }).toDestination();
    
    bassSynth = new Tone.MonoSynth({
        oscillator: { type: "triangle" },
        envelope: { attack: 0.02, decay: 0.3, sustain: 0.6, release: 0.4 },
        filterEnvelope: {
            attack: 0.01,
            decay: 0.1,
            sustain: 0.5,
            release: 0.3,
            baseFrequency: 200,
            octaves: 2
        },
        volume: -6
    });
    bassSynth.connect(bassFilter); // Bass stays DRY (no reverb = tight low end)

    Tone.Transport.bpm.value = TEMPO;
    Tone.Transport.swing = 0.3; // Jazz swing
    Tone.Transport.swingSubdivision = "8n";
}

/**
 * GENERATOR LOGIC
 */

// Helper: MIDI handling
function getMidi(pc, octave) { return pc + (octave + 1) * 12; }
function randomEl(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

// Helper: Find nearest note in a scale/chord array to a target pitch
function findNearest(target, pool) {
    return pool.reduce((prev, curr) => 
        Math.abs(curr - target) < Math.abs(prev - target) ? curr : prev
    );
}

// Global State
let lastNoteMidi = 72; // Start around C5

// The Core Generator Function
function generatePhrase(barIndex, time, chordIdx) {
    const chordDef = CHORD_PROGRESSION[chordIdx];
    
    // 1. Play Background Chord (Comping) - Spread voicing for openness
    // Drop the 2nd note down an octave for "drop 2" voicing
    const voicing = [
        getMidi(chordDef.tones[0], 3),      // Root stays
        getMidi(chordDef.tones[1], 2),      // 3rd dropped an octave
        getMidi(chordDef.tones[2], 3),      // 5th stays
        getMidi(chordDef.tones[3], 3)       // 7th stays
    ];
    chordSynth.triggerAttackRelease(voicing.map(n => Tone.Frequency(n, "midi")), "1n", time);
    
    // 2. Walking Bass - Play on all 4 beats for authentic jazz feel
    const bassOctave = 2;
    const scale = SCALES[chordDef.scale];
    const rootMidi = getMidi(chordDef.root, bassOctave);
    
    // Beat 1: Root
    bassSynth.triggerAttackRelease(Tone.Frequency(rootMidi, "midi"), "8n", time);
    
    // Beat 2: 3rd or 5th
    const beat2Note = getMidi(chordDef.tones[Math.random() > 0.5 ? 1 : 2], bassOctave);
    bassSynth.triggerAttackRelease(Tone.Frequency(beat2Note, "midi"), "8n", time + Tone.Time("4n").toSeconds());
    
    // Beat 3: 5th
    const fifthMidi = getMidi(chordDef.tones[2], bassOctave);
    bassSynth.triggerAttackRelease(Tone.Frequency(fifthMidi, "midi"), "8n", time + Tone.Time("4n").toSeconds() * 2);
    
    // Beat 4: Chromatic approach to next root (half step below or above)
    const nextChord = CHORD_PROGRESSION[(CHORD_PROGRESSION.indexOf(chordDef) + 1) % 4];
    const nextRoot = getMidi(nextChord.root, bassOctave);
    const approachNote = nextRoot + (Math.random() > 0.5 ? 1 : -1); // Chromatic neighbor
    bassSynth.triggerAttackRelease(Tone.Frequency(approachNote, "midi"), "8n", time + Tone.Time("4n").toSeconds() * 3);
    
    // Update UI
    Tone.Draw.schedule(() => {
        document.getElementById('currentChord').innerText = chordDef.name;
        document.getElementById('phraseStatus').innerText = "Improvising...";
    }, time);

    // 3. Generate Melody
    const pattern = randomEl(RHYTHMS);
    
    // Convert generic pitch classes to actual MIDI pools
    const scalePool = SCALES[chordDef.scale].map(pc => getMidi(pc, 4)).concat(SCALES[chordDef.scale].map(pc => getMidi(pc, 5)));
    const chordPool = chordDef.tones.map(pc => getMidi(pc, 4)).concat(chordDef.tones.map(pc => getMidi(pc, 5)));
    
    // Guide Tones (3rd and 7th) for Voice Leading
    // 3rd is index 1, 7th is index 3 in our tones array
    const guideTones = [chordDef.tones[1], chordDef.tones[3]].map(pc => getMidi(pc, 4));

    pattern.forEach((step, index) => {
        if (step === 0) return; // Rest

        const beatOffset = index * 0.5; // Eighth notes
        const noteTime = time + Tone.Time("8n").toSeconds() * index;
        const isStrongBeat = (index === 0 || index === 4);
        
        // --- LOGIC IMPROVEMENT 1: Voice Leading ---
        // If it's the first note of the bar, try to resolve to a guide tone (3rd/7th)
        let targetPool = scalePool;
        let preferGuideTone = (index === 0 && Math.random() < 0.7); 

        if (preferGuideTone) {
            targetPool = guideTones;
        } else if (isStrongBeat) {
            targetPool = chordPool; // Prefer chord tones on beat 1 & 3
        } else {
            // Passing tones allowed, occasional chromaticism could be added here
            if (Math.random() < 0.1) {
                // simple chromatic: previous note +/- 1
                let chrom = lastNoteMidi + (Math.random() > 0.5 ? 1 : -1);
                targetPool = [chrom];
            }
        }

        // --- LOGIC IMPROVEMENT 2: Smooth Contours ---
        // Find note in pool closest to last note
        let note = findNearest(lastNoteMidi, targetPool);
        
        // Add some jumps for variety (15% chance)
        if (Math.random() < 0.15) {
            const jump = Math.random() > 0.5 ? 5 : 7; // 4th or 5th
            const dir = Math.random() > 0.5 ? 1 : -1;
            note = findNearest(lastNoteMidi + (jump*dir), targetPool);
        }

        // Keep in register (Middle C to E6)
        if (note < 60) note += 12;
        if (note > 80) note -= 12;

        lastNoteMidi = note;
        const velocity = 0.5 + Math.random() * 0.4; // Humanize velocity

        // Schedule Note
        synth.triggerAttackRelease(
            Tone.Frequency(note, "midi"), 
            "8n", 
            noteTime, 
            velocity
        );

        // UI Feedback
        Tone.Draw.schedule(() => {
            document.getElementById('noteLog').innerText = `MIDI: ${note}`;
        }, noteTime);
    });
}

/**
 * SCHEDULER
 */
let loop;

function startLoop() {
    let barCount = 0;
    
    // Loop every measure (1m)
    loop = new Tone.Loop((time) => {
        // Determine where we are in the 4-bar progression
        let progressionIndex = barCount % 4;
        
        generatePhrase(barCount, time, progressionIndex);
        
        barCount++;
    }, "1m").start(0);

    Tone.Transport.start();
    isPlaying = true;
    document.getElementById('startBtn').innerText = "Stop Jazz";
    document.getElementById('startBtn').style.background = "#c0392b";
}

function stopLoop() {
    if(loop) loop.dispose();
    Tone.Transport.stop();
    isPlaying = false;
    document.getElementById('startBtn').innerText = "Start Jazz";
    document.getElementById('startBtn').style.background = "#e67e22";
    document.getElementById('currentChord').innerText = "--";
    document.getElementById('phraseStatus').innerText = "Stopped";
}

// Interaction
document.getElementById('startBtn').addEventListener('click', async () => {
    if (!isPlaying) {
        await initAudio();
        startLoop();
    } else {
        stopLoop();
    }
});

</script>
</body>
</html>